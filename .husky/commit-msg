#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

echo "Husky commit-msg Running!"

# Get current branch name
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)

# Check branch name format
if ! echo "$BRANCH_NAME" | grep -qE '^(feature|bugfix)/KAN-[0-9]+-[a-zA-Z0-9-]+$'; then
    echo "Error: Branch name must follow the format 'feature/KAN-{number}-{content}' or 'bugfix/KAN-{number}-{content}'"
    echo "Current branch name: $BRANCH_NAME"
    exit 1
fi

echo "Branch name validation passed!"

COMMIT_MSG=$(cat "$1")

echo "COMMIT_MSG: $COMMIT_MSG"

# Skip ticket number validation for merge commits
if echo "$COMMIT_MSG" | grep -q "^Merge"; then
    echo "Merge commit detected, skipping ticket number validation"
    exit 0
fi

# Extract ticket number from commit message (everything before :)
COMMIT_TICKET=$(echo "$COMMIT_MSG" | cut -d: -f1)

# Extract ticket number from branch name (from first / to second -)
BRANCH_TICKET=$(echo "$BRANCH_NAME" | sed 's/^[^/]*\///' | cut -d- -f1-2)

# Compare ticket numbers
if [ "$COMMIT_TICKET" != "$BRANCH_TICKET" ]; then
    echo "Error: Ticket number in commit message ($COMMIT_TICKET) does not match branch ticket number ($BRANCH_TICKET)"
    exit 1
fi

echo "Ticket number validation passed!"
